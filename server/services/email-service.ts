/**
 * Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
 * Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… nodemailer
 */

import nodemailer from 'nodemailer';
import { eq, and, desc, gte, sql } from 'drizzle-orm';
import { db } from '../db.js';
import { emailVerificationTokens, passwordResetTokens, users } from '../../shared/schema.js';
import { hashPassword } from '../auth/crypto-utils.js';
import crypto from 'crypto';

// ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: Ø¥Ù†Ø´Ø§Ø¡ transporter ÙˆØ§Ø­Ø¯ Ù…Ø¹ connection pooling
let emailTransporter: nodemailer.Transporter | null = null;

const getEmailTransporter = (): nodemailer.Transporter => {
  if (!emailTransporter) {
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
    const smtpUser = process.env.SMTP_USER?.trim().replace(/\s+/g, '') || '';
    const smtpPort = parseInt(process.env.SMTP_PORT || '587');
    
    const smtpConfig = {
      host: process.env.SMTP_HOST,
      port: smtpPort,
      secure: smtpPort === 465, // true for 465, false for other ports
      pool: true, // ØªÙ…ÙƒÙŠÙ† connection pooling
      maxConnections: 5, // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
      maxMessages: 100, // Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù„ÙƒÙ„ Ø§ØªØµØ§Ù„
      rateLimit: 14, // Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©)
      keepAlive: true, // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ÙØªÙˆØ­Ø§Ù‹
      auth: {
        user: smtpUser,
        pass: process.env.SMTP_PASS,
      },
      tls: {
        rejectUnauthorized: false
      }
    };

    console.log('ğŸš€ [EmailService] Ø¥Ù†Ø´Ø§Ø¡ transporter Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ connection pooling:', {
      host: smtpConfig.host,
      port: smtpConfig.port,
      secure: smtpConfig.secure,
      pool: smtpConfig.pool,
      maxConnections: smtpConfig.maxConnections,
      user: smtpUser,
      hasPassword: !!smtpConfig.auth.pass
    });

    emailTransporter = nodemailer.createTransport(smtpConfig);
  }
  return emailTransporter!;
};

// ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
export async function verifyEmailConfiguration(): Promise<boolean> {
  try {
    const transporter = getEmailTransporter();
    await transporter.verify();
    console.log('âœ… [EmailService] ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ SMTP Ø¨Ù†Ø¬Ø§Ø­');
    return true;
  } catch (error) {
    console.error('âŒ [EmailService] ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ SMTP:', error);
    return false;
  }
}

// ØªÙ‡ÙŠØ¦Ø© transporter Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
export async function initializeEmailService(): Promise<void> {
  console.log('ğŸ”§ [EmailService] ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ...');
  try {
    await verifyEmailConfiguration();
    console.log('âœ… [EmailService] ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
  } catch (error) {
    console.error('âŒ [EmailService] ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:', error);
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ Ø¹Ø´ÙˆØ§Ø¦ÙŠ (6 Ø£Ø±Ù‚Ø§Ù…)
function generateVerificationCode(): string {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø¢Ù…Ù† Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
function generateSecureToken(): string {
  return crypto.randomBytes(32).toString('hex');
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ¦Ø©
function getDynamicDomain(req?: any): string {
  // Ø£ÙˆÙ„ÙˆÙŠØ© Ø£ÙˆÙ„Ù‰: Ø§Ø³ØªØ®Ø¯Ø§Ù… REPLIT_DOMAINS Ù…Ù† Ø¨ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… (Ø®Ø§Øµ Ø¨Ø±ÙŠØ¨Ù„ÙŠØª)
  if (process.env.REPLIT_DOMAINS) {
    const domains = process.env.REPLIT_DOMAINS.split(',');
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ø°ÙŠ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ .replit.dev
    const replitDomain = domains.find(d => d.includes('.replit.dev'));
    if (replitDomain) {
      console.log('ğŸŒ [EmailService] Ø§Ø³ØªØ®Ø¯Ø§Ù… REPLIT_DOMAINS:', replitDomain);
      return replitDomain;
    }
    console.log('ğŸŒ [EmailService] Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙˆÙ„ Ø¯ÙˆÙ…ÙŠÙ† Ù…ØªØ§Ø­:', domains[0]);
    return domains[0];
  }

  // Ø£ÙˆÙ„ÙˆÙŠØ© Ø«Ø§Ù†ÙŠØ©: Ø§Ø³ØªØ®Ø¯Ø§Ù… Host header Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù† ÙˆØ¬Ø¯
  if (req && req.headers && req.headers.host) {
    console.log('ğŸŒ [EmailService] Ø§Ø³ØªØ®Ø¯Ø§Ù… Host header:', req.headers.host);
    return req.headers.host;
  }

  // Ø£ÙˆÙ„ÙˆÙŠØ© Ø«Ø§Ù„Ø«Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… DOMAIN Ù…Ù† Ù…Ù„Ù .env
  if (process.env.DOMAIN && process.env.DOMAIN.trim()) {
    let domainValue = process.env.DOMAIN.trim().replace(/^(https?:\/\/)/, '');
    console.log('ğŸŒ [EmailService] Ø§Ø³ØªØ®Ø¯Ø§Ù… DOMAIN Ù…Ù† .env:', domainValue);
    return domainValue;
  }
  
  // ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±
  if (process.env.NODE_ENV === 'development') {
    console.log('ğŸŒ [EmailService] Ø§Ø³ØªØ®Ø¯Ø§Ù… localhost Ù„Ù„ØªØ·ÙˆÙŠØ±');
    return process.env.PRODUCTION_DOMAIN ? process.env.PRODUCTION_DOMAIN.replace(/^(https?:\/\/)/, '') : 'app2.binarjoinanelytic.info';
  }
  
  // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ¦Ø©
  const defaultDomain = process.env.PRODUCTION_DOMAIN ? process.env.PRODUCTION_DOMAIN.replace(/^(https?:\/\/)/, '') : 'app2.binarjoinanelytic.info';
  
  console.log('ğŸŒ [EmailService] Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:', defaultDomain);
  return defaultDomain;
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„
function getProtocol(): string {
  return process.env.NODE_ENV === 'production' ? 'https' : 'http';
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø±Ù…ÙˆØ²
async function hashToken(token: string): Promise<string> {
  return crypto.createHash('sha256').update(token).digest('hex');
}

// Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
const emailTemplates = {
  verification: (code: string, verificationLink: string, userFullName?: string) => ({
    subject: 'ğŸ” ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
    html: `
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ</title>
        <style>
          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
          .container { max-width: 600px; margin: 40px auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
          .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 40px; text-align: center; }
          .header h1 { margin: 0; font-size: 28px; font-weight: bold; }
          .content { padding: 40px; text-align: center; }
          .verification-code { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; font-size: 32px; font-weight: bold; letter-spacing: 8px; margin: 30px 0; display: inline-block; }
          .button { display: inline-block; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px 30px; border-radius: 50px; text-decoration: none; font-weight: bold; margin: 20px 0; transition: transform 0.3s ease; }
          .button:hover { transform: translateY(-2px); }
          .footer { background: #f8f9fa; padding: 30px; text-align: center; color: #6c757d; border-top: 1px solid #e9ecef; }
          .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 10px; margin: 20px 0; color: #856404; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>ğŸ” ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ</h1>
            <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠØ©</p>
          </div>
          <div class="content">
            <h2>${userFullName ? `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userFullName}!` : 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!'}</h2>
            <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹. Ù„Ø¥ÙƒÙ…Ø§Ù„ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ÙƒØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªØ§Ù„ÙŠ:</p>
            
            <div class="verification-code" style="cursor: pointer; user-select: all; position: relative;">
              ${code}
              <small style="display: block; font-size: 12px; margin-top: 10px; opacity: 0.8;">Ø§Ù†Ù‚Ø± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</small>
            </div>
            
            <p>Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ø¨Ø§Ø´Ø±Ø©:</p>
            <a href="${verificationLink}" class="button">âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</a>
            
            <div class="warning">
              <strong>ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ:</strong>
              <ul style="text-align: right; margin: 10px 0;">
                <li>Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø© ÙÙ‚Ø·</li>
                <li>Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ Ø£ÙŠ Ø´Ø®Øµ Ø¢Ø®Ø±</li>
                <li>Ø¥Ø°Ø§ Ù„Ù… ØªØ·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù‚Ù‚ØŒ ÙŠØ±Ø¬Ù‰ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯</li>
              </ul>
            </div>
          </div>
          <div class="footer">
            <p>Â© 2025 Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
            <p>Ù‡Ø°Ø§ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡</p>
          </div>
        </div>
      </body>
      </html>
    `,
    text: `
      ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
      
      ${userFullName ? `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userFullName}!` : 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!'}
      Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹.
      
      Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: ${code}
      
      Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ: ${verificationLink}
      
      Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø© ÙÙ‚Ø·.
      Ø¥Ø°Ø§ Ù„Ù… ØªØ·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù‚Ù‚ØŒ ÙŠØ±Ø¬Ù‰ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.
    `
  }),

  passwordReset: (resetLink: string, userEmail: string) => ({
    subject: 'ğŸ”‘ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
    html: `
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</title>
        <style>
          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
          .container { max-width: 600px; margin: 40px auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
          .header { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 40px; text-align: center; }
          .header h1 { margin: 0; font-size: 28px; font-weight: bold; }
          .content { padding: 40px; text-align: center; }
          .button { display: inline-block; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 15px 30px; border-radius: 50px; text-decoration: none; font-weight: bold; margin: 20px 0; transition: transform 0.3s ease; }
          .button:hover { transform: translateY(-2px); }
          .footer { background: #f8f9fa; padding: 30px; text-align: center; color: #6c757d; border-top: 1px solid #e9ecef; }
          .warning { background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 10px; margin: 20px 0; color: #721c24; }
          .info { background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 10px; margin: 20px 0; color: #0c5460; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>ğŸ”‘ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h1>
            <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠØ©</p>
          </div>
          <div class="content">
            <h2>Ø·Ù„Ø¨ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <p>ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù€: <strong>${userEmail}</strong></p>
            
            <p>Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©:</p>
            <a href="${resetLink}" class="button">ğŸ” Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</a>
            
            <div class="warning">
              <strong>ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ Ù…Ù‡Ù…:</strong>
              <ul style="text-align: right; margin: 10px 0;">
                <li>Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·</li>
                <li>ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·</li>
                <li>Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø£ÙŠ Ø´Ø®Øµ Ø¢Ø®Ø±</li>
              </ul>
            </div>
            
            <div class="info">
              <strong>Ø¥Ø°Ø§ Ù„Ù… ØªØ·Ù„Ø¨ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</strong>
              <p>ÙŠØ±Ø¬Ù‰ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø£Ù…Ø§Ù†</p>
            </div>
          </div>
          <div class="footer">
            <p>Â© 2025 Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
            <p>Ù‡Ø°Ø§ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡</p>
          </div>
        </div>
      </body>
      </html>
    `,
    text: `
      Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
      
      ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø­Ø³Ø§Ø¨: ${userEmail}
      
      Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ: ${resetLink}
      
      Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.
      Ø¥Ø°Ø§ Ù„Ù… ØªØ·Ù„Ø¨ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ ÙŠØ±Ø¬Ù‰ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.
    `
  })
};

/**
 * Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
 */
export async function sendVerificationEmail(
  userId: string,
  email: string,
  ipAddress?: string,
  userAgent?: string,
  userFullName?: string,
  req?: any
): Promise<{ success: boolean; message: string }> {
  try {
    console.log('ğŸ“§ [EmailService] Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userId);

    // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…ÙˆØ² Ø§Ù„ØªØ­Ù‚Ù‚
    if (email === 'binarjoinanalytic@gmail.com') {
      console.log('âš ï¸ [EmailService] Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…ÙˆØ² ØªØ­Ù‚Ù‚');
      // ØªØ­Ù‚ÙŠÙ‚ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      await db.update(users)
        .set({ emailVerifiedAt: new Date() })
        .where(eq(users.id, userId));
      
      return {
        success: true,
        message: 'Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ Ù…Ø­Ù‚Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹'
      };
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ÙÙ…Ø±Ø± Ù…Ø¨Ø§Ø´Ø±Ø© - Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠ
    const displayName = userFullName?.trim() || null;
    console.log('ğŸ‘¤ [EmailService] Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ÙÙ…Ø±Ø± Ù…Ø¨Ø§Ø´Ø±Ø©:', displayName || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    const isConfigValid = await verifyEmailConfiguration();
    if (!isConfigValid) {
      return {
        success: false,
        message: 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'
      };
    }

    // Ø­Ø°Ù Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await db.delete(emailVerificationTokens)
      .where(and(
        eq(emailVerificationTokens.userId, userId),
        eq(emailVerificationTokens.email, email)
      ));

    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ Ø¬Ø¯ÙŠØ¯
    const verificationCode = generateVerificationCode();
    const tokenHash = await hashToken(verificationCode);
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚
    const domain = getDynamicDomain(req);
    const protocol = getProtocol();
    const verificationLink = `${protocol}://${domain}/verify-email?token=${verificationCode}&userId=${userId}`;
    
    console.log('ğŸ”— [EmailService] Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙÙ†Ø´Ø£:', verificationLink);

    // Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø² ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const expiresAt = new Date();
    expiresAt.setHours(expiresAt.getHours() + 24); // ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø©

    await db.insert(emailVerificationTokens).values({
      userId,
      email,
      token: verificationCode,
      tokenHash,
      verificationLink,
      expiresAt,
      ipAddress,
      userAgent
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    const transporter = getEmailTransporter();
    const emailTemplate = emailTemplates.verification(verificationCode, verificationLink, displayName || undefined);

    const cleanEmail = process.env.SMTP_USER?.trim().replace(/\s+/g, '') || '';
    await transporter.sendMail({
      from: `"Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹" <${cleanEmail}>`,
      to: email,
      subject: emailTemplate.subject,
      html: emailTemplate.html,
      text: emailTemplate.text
    });

    console.log('âœ… [EmailService] ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰:', email);

    return {
      success: true,
      message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'
    };

  } catch (error) {
    console.error('âŒ [EmailService] ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚:', error);
    return {
      success: false,
      message: 'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹'
    };
  }
}

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
 */
export async function verifyEmailToken(
  userId: string,
  token: string
): Promise<{ success: boolean; message: string }> {
  try {
    console.log('ğŸ” [EmailService] Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²:', { userId, tokenLength: token.length });

    // ÙØ­Øµ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„
    const userCheck = await db.select({ 
      email: users.email, 
      emailVerifiedAt: users.emailVerifiedAt 
    })
      .from(users)
      .where(eq(users.id, userId))
      .limit(1);

    const isFirstAdmin = userCheck.length > 0 && userCheck[0].email === 'binarjoinanalytic@gmail.com';
    
    // Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø­Ù‚Ù‚ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹
    if (isFirstAdmin) {
      console.log('âœ… [EmailService] ØªØ­Ù‚ÙŠÙ‚ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...');
      await db.update(users)
        .set({ emailVerifiedAt: new Date() })
        .where(eq(users.id, userId));
      
      return {
        success: true,
        message: 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­'
      };
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ù…Ø² ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const tokenRecord = await db.select()
      .from(emailVerificationTokens)
      .where(and(
        eq(emailVerificationTokens.userId, userId),
        eq(emailVerificationTokens.token, token)
      ))
      .limit(1);

    console.log('ğŸ” [EmailService] Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«:', { found: tokenRecord.length > 0, userId, token });

    if (tokenRecord.length === 0) {
      console.log('âŒ [EmailService] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²');
      return {
        success: false,
        message: 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ§Ù„Ø­'
      };
    }

    const record = tokenRecord[0];
    console.log('âœ… [EmailService] ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²:', { id: record.id, verifiedAt: record.verifiedAt });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    if (new Date() > record.expiresAt) {
      console.log('âŒ [EmailService] Ø§Ù„Ø±Ù…Ø² Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
      // Ø­Ø°Ù Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
      await db.delete(emailVerificationTokens)
        .where(eq(emailVerificationTokens.id, record.id));

      return {
        success: false,
        message: 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯'
      };
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù…Ø² Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ù† Ù‚Ø¨Ù„
    if (record.verifiedAt) {
      console.log('âŒ [EmailService] Ø§Ù„Ø±Ù…Ø² ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
      return {
        success: false,
        message: 'ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø³Ø¨Ù‚Ø§Ù‹'
      };
    }

    console.log('ğŸ”„ [EmailService] Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø±Ù…ÙˆØ² Ø§Ù„ØªØ­Ù‚Ù‚
    const tokenUpdate = await db.update(emailVerificationTokens)
      .set({ verifiedAt: new Date() })
      .where(eq(emailVerificationTokens.id, record.id));
    
    console.log('ğŸ“ [EmailService] ØªÙ… ØªØ­Ø¯ÙŠØ« email_verification_tokens');

    // ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ£ÙƒÙŠØ¯ ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    const userUpdate = await db.update(users)
      .set({ emailVerifiedAt: new Date() })
      .where(eq(users.id, userId));
    
    console.log('ğŸ“ [EmailService] ØªÙ… ØªØ­Ø¯ÙŠØ« users Ø¨Ù†Ø¬Ø§Ø­');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙˆØ±Ø§Ù‹
    const verifyUpdate = await db.select({
      id: users.id,
      email: users.email,
      emailVerifiedAt: users.emailVerifiedAt
    })
      .from(users)
      .where(eq(users.id, userId))
      .limit(1);
    
    console.log('ğŸ” [EmailService] ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', verifyUpdate.length > 0 ? verifyUpdate[0] : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');

    console.log('âœ… [EmailService] Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userId);

    return {
      success: true,
      message: 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­'
    };

  } catch (error) {
    console.error('âŒ [EmailService] Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²:', error);
    return {
      success: false,
      message: 'ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø². ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹'
    };
  }
}

/**
 * Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
 */
export async function sendPasswordResetEmail(
  email: string,
  ipAddress?: string,
  userAgent?: string,
  req?: any
): Promise<{ success: boolean; message: string }> {
  try {
    console.log('ğŸ”‘ [EmailService] Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¨Ø±ÙŠØ¯:', email);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userResult = await db.select()
      .from(users)
      .where(eq(users.email, email))
      .limit(1);

    if (userResult.length === 0) {
      // Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø£Ù…Ø§Ù†ØŒ Ù†Ø±Ø³Ù„ Ù†ÙØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      return {
        success: true,
        message: 'Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'
      };
    }

    const user = userResult[0];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    const isConfigValid = await verifyEmailConfiguration();
    if (!isConfigValid) {
      return {
        success: false,
        message: 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'
      };
    }

    // Ø­Ø°Ù Ø±Ù…ÙˆØ² Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await db.delete(passwordResetTokens)
      .where(eq(passwordResetTokens.userId, user.id));

    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ø¯ÙŠØ¯
    const resetToken = generateSecureToken();
    const tokenHash = await hashToken(resetToken);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹
    const domain = getDynamicDomain(req);
    const protocol = getProtocol();
    const resetLink = `${protocol}://${domain}/reset-password?token=${resetToken}`;
    
    console.log('ğŸ”— [EmailService] Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙÙ†Ø´Ø£:', resetLink);

    // Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø² ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const expiresAt = new Date();
    expiresAt.setHours(expiresAt.getHours() + 1); // ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©

    await db.insert(passwordResetTokens).values({
      userId: user.id,
      token: resetToken,
      tokenHash,
      expiresAt,
      ipAddress,
      userAgent
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    const transporter = getEmailTransporter();
    const emailTemplate = emailTemplates.passwordReset(resetLink, email);

    const cleanEmail = process.env.SMTP_USER?.trim().replace(/\s+/g, '') || '';
    await transporter.sendMail({
      from: `"Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹" <${cleanEmail}>`,
      to: email,
      subject: emailTemplate.subject,
      html: emailTemplate.html,
      text: emailTemplate.text
    });

    console.log('âœ… [EmailService] ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰:', email);

    return {
      success: true,
      message: 'Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'
    };

  } catch (error) {
    console.error('âŒ [EmailService] ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', error);
    return {
      success: false,
      message: 'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹'
    };
  }
}

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù…Ø² Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
 */
export async function resetPasswordWithToken(
  token: string,
  newPassword: string
): Promise<{ success: boolean; message: string }> {
  try {
    console.log('ğŸ” [EmailService] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù…Ø² Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ù…Ø² ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const tokenRecord = await db.select()
      .from(passwordResetTokens)
      .where(eq(passwordResetTokens.token, token))
      .limit(1);

    if (tokenRecord.length === 0) {
      return {
        success: false,
        message: 'Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ØºÙŠØ± ØµØ§Ù„Ø­'
      };
    }

    const record = tokenRecord[0];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    if (new Date() > record.expiresAt) {
      // Ø­Ø°Ù Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
      await db.delete(passwordResetTokens)
        .where(eq(passwordResetTokens.id, record.id));

      return {
        success: false,
        message: 'Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯'
      };
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù…Ø² Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ù† Ù‚Ø¨Ù„
    if (record.usedAt) {
      return {
        success: false,
        message: 'ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø³Ø¨Ù‚Ø§Ù‹'
      };
    }

    // ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const hashedPassword = await hashPassword(newPassword);

    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await db.update(users)
      .set({ password: hashedPassword })
      .where(eq(users.id, record.userId));

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ù…Ø² ÙƒÙ…Ø³ØªØ®Ø¯Ù…
    await db.update(passwordResetTokens)
      .set({ usedAt: new Date() })
      .where(eq(passwordResetTokens.id, record.id));

    console.log('âœ… [EmailService] ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', record.userId);

    return {
      success: true,
      message: 'ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­'
    };

  } catch (error) {
    console.error('âŒ [EmailService] ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', error);
    return {
      success: false,
      message: 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹'
    };
  }
}

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù…Ø² Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)
 */
export async function validatePasswordResetToken(token: string): Promise<{ success: boolean; message: string }> {
  try {
    const tokenRecord = await db.select()
      .from(passwordResetTokens)
      .where(eq(passwordResetTokens.token, token))
      .limit(1);

    if (tokenRecord.length === 0) {
      return {
        success: false,
        message: 'Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ØºÙŠØ± ØµØ§Ù„Ø­'
      };
    }

    const record = tokenRecord[0];

    if (new Date() > record.expiresAt) {
      return {
        success: false,
        message: 'Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©'
      };
    }

    if (record.usedAt) {
      return {
        success: false,
        message: 'ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø³Ø¨Ù‚Ø§Ù‹'
      };
    }

    return {
      success: true,
      message: 'Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ØµØ§Ù„Ø­'
    };

  } catch (error) {
    console.error('âŒ [EmailService] ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹:', error);
    return {
      success: false,
      message: 'ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²'
    };
  }
}