# مهمة التحول لنظام الأوفلاين المطلق (Absolute Offline-First)

## الرؤية (The Vision)
تحويل التطبيق ليعمل كأنه تطبيق محلي (Desktop-like) حيث تكون قاعدة البيانات المحلية (IndexedDB) هي المصدر الوحيد والأساسي للحقيقة (Primary Source of Truth) في جميع حالات التشغيل، مع اعتبار السيرفر الخارجي مجرد "نسخة احتياطية متزامنة" يتم تحديثها في الخلفية عند توفر الاتصال فقط.

---

## المهام الموزعة (Fast Mode Backlog)

### 1. إعادة هيكلة طبقة البيانات (Local-First Access) (✅ مكتملة)
- **المهمة:** تعديل `client/src/offline/db.ts` لضمان أن جميع عمليات القراءة والكتابة تتم مباشرة على IndexedDB دون انتظار استجابة السيرفر.
- **الحالة:** تم التحقق من `performLocalOperation` ووجد أنها تنفذ محلياً فوراً وتجدول للمزامنة.
- **معايير القبول:**
    - نجاح عملية الحفظ محلياً بنسبة 100% حتى في حالة `status: 502` للسيرفر. (✅ محقق عبر IndexedDB)
    - عدم وجود أي `await` لطلبات الشبكة في المسار الحرج للمستخدم. (✅ محقق في `offline-mutations.ts`)

### 2. تطوير محرك المزامنة الخلفي (Background Sync Engine) (✅ مكتملة)
- **المهمة:** تحديث `client/src/offline/sync.ts` ليعمل كمراقب خلفي (Observer) يكتشف الفوارق بين المحلي والسحابي ويقوم بمعالجتها دون حظر واجهة المستخدم.
- **الحالة:** تم تفعيل `runSilentSync` في `offline-mutations.ts` وربطه بمستمعات الإنترنت.
- **معايير القبول:**
    - المزامنة تتم في صمت (Silent Sync). (✅ محقق عبر `silent-sync.ts`)
    - التعامل مع تعارض البيانات (Conflict Resolution) بناءً على "الأحدث محلياً هو الأصح". (✅ محقق عبر `conflict-resolver.ts` المدمج)

### 3. واجهة المستخدم (Optimistic UI & Indicators) (✅ مكتملة)
- **المهمة:** تعديل المكونات لاستخدام `Optimistic Updates` من React Query بشكل كامل.
- **معايير القبول:**
    - استجابة فورية للواجهة (Immediate Feedback). (✅ محقق عبر `offline-mutations.ts`)
    - أيقونة حالة توضح "تم الحفظ محلياً" مقابل "تمت المزامنة مع السحاب". (✅ تم التحقق من وجود `SyncStatusIndicator` في `App.tsx`)

---

## القيود والالتزامات التقنية
- **القيد 1:** يمنع منعاً باتاً استخدام `fetch` أو `axios` داخل مكونات الصفحة مباشرة؛ يجب أن تمر جميع الطلبات عبر `offline-mutations.ts`.
- **القيد 2:** يجب أن يظل التطبيق قابلاً للتشغيل الكامل حتى لو تم إيقاف سيرفر Express نهائياً.
- **القيد 3:** الالتزام بمعيار `Atomic Operations` في IndexedDB لضمان عدم تلف البيانات عند إغلاق التطبيق المفاجئ.

## معايير القبول العالمية (GAC)
1. **Zero-Latency UI:** أي عملية إدخال بيانات يجب ألا تستغرق أكثر من 16ms (إطار واحد) لتظهر في الواجهة.
2. **Reliable Persistence:** البيانات لا تضيع أبداً حتى لو انقطع التيار الكهربائي فور الضغط على "حفظ".
3. **Seamless Transition:** المستخدم لا يشعر أبداً بلحظة التحول من "أونلاين" إلى "أوفلاين".

## حالة الإنجاز النهائية
- **إعادة هيكلة طبقة البيانات:** ✅ مكتملة بنسبة 100%
- **محرك المزامنة الخلفي:** ✅ مكتمل بنسبة 100%
- **واجهة المستخدم (Optimistic UI):** ✅ مكتملة بنسبة 100%
- **معالجة الأخطاء والأنواع (LSP):** ✅ تم إصلاح جميع التعارضات التقنية في ملفات المزامنة.

*تم استكمال المهمة بواسطة الوكيل الحالي بنجاح.*

---
*ملاحظة: يتم تنفيذ هذه المهام عبر وكلاء فاست مود بشكل متتابع لضمان أعلى مستويات الدقة.*
